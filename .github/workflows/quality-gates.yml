name: Quality Gates

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  lint:
    name: Code Quality & Linting
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install black isort flake8 pylint

      - name: Check code formatting with Black
        run: |
          black --check --line-length=100 scripts/ tests/
        continue-on-error: true

      - name: Check import sorting with isort
        run: |
          isort --check-only --profile black scripts/ tests/
        continue-on-error: true

      - name: Lint with flake8
        run: |
          flake8 scripts/ --max-line-length=100 --extend-ignore=E203,W503,E501 --count --statistics
        continue-on-error: true

      - name: Lint with pylint
        run: |
          pylint scripts/ --max-line-length=100 --disable=C0111,C0103,R0903,R0913,W0212 || true
        continue-on-error: true

  security:
    name: Security Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements-dev.txt
          pip install bandit pip-audit safety

      - name: Run Bandit security scanner
        run: |
          bandit -r scripts/ -c .bandit.yml -f json -o bandit-report.json
        continue-on-error: true

      - name: Upload Bandit results
        uses: actions/upload-artifact@v5
        with:
          name: bandit-report
          path: bandit-report.json
        if: always()

      - name: Check for dependency vulnerabilities (pip-audit)
        run: |
          pip-audit --desc --format json > pip-audit-report.json || true
        continue-on-error: true

      - name: Upload pip-audit results
        uses: actions/upload-artifact@v5
        with:
          name: pip-audit-report
          path: pip-audit-report.json
        if: always()

      - name: Run Safety check
        run: |
          safety check --json > safety-report.json || true
        continue-on-error: true

  pyguard:
    name: PyGuard Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Checkout PyGuard
        uses: actions/checkout@v5
        with:
          repository: cboyd0319/PyGuard
          path: PyGuard

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install PyGuard dependencies
        run: |
          pip install --upgrade pip
          pip install rich typer pyyaml requests

      - name: Run PyGuard scan
        run: |
          python3 run_pyguard.py || true
        continue-on-error: true

  syntax-check:
    name: Python Syntax Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Syntax check all Python files
        run: |
          find scripts/ tests/ -name '*.py' -exec python3 -m py_compile {} \;

      - name: Check for syntax errors
        run: |
          python3 -m compileall scripts/ tests/

  documentation:
    name: Documentation Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Check for TODO comments
        run: |
          TODO_COUNT=$(grep -r "TODO\|FIXME\|XXX\|HACK" scripts/ --include="*.py" | wc -l || echo 0)
          echo "Found $TODO_COUNT TODO comments"
          if [ "$TODO_COUNT" -gt 10 ]; then
            echo "::warning::High number of TODO comments ($TODO_COUNT) - consider addressing them"
          fi

      - name: Check for missing docstrings
        run: |
          pip install pydocstyle
          pydocstyle scripts/ --count || true
        continue-on-error: true

  quality-summary:
    name: Quality Summary
    runs-on: ubuntu-latest
    needs: [lint, security, syntax-check, documentation]
    if: always()

    steps:
      - name: Check job results
        run: |
          echo "## Quality Gates Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Linting: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security: ${{ needs.security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Syntax Check: ${{ needs.syntax-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Documentation: ${{ needs.documentation.result }}" >> $GITHUB_STEP_SUMMARY
